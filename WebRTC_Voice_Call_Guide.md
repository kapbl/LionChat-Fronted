# WebRTC语音通话功能使用指南

## 功能概述

本项目已成功集成WebRTC语音通话功能，用户可以在聊天界面中进行实时语音通话。

## 新增功能

### 1. 语音通话界面
- **通话按钮**: 在聊天头部添加了📞按钮，点击可发起语音通话
- **来电界面**: 收到语音通话邀请时显示来电界面，可选择接听或拒绝
- **通话中界面**: 显示通话时长、静音和扬声器控制按钮

### 2. 消息类型扩展
- 新增contentType = 6，用于WebRTC信令消息传输
- 更新了protobuf消息定义，支持更多消息类型

### 3. WebRTC功能
- 使用浏览器原生WebRTC API
- 支持音频流传输
- 自动处理ICE候选和信令交换
- 内置STUN服务器配置

## 技术实现

### 文件结构
```
src/components/chat2/
├── WebRTCVoiceCall.vue     # WebRTC语音通话组件
├── MessageLayout.vue       # 主聊天界面（已更新）
├── websocket.js           # WebSocket连接管理
└── ...
```

### 核心组件

#### WebRTCVoiceCall.vue
- 管理WebRTC连接和媒体流
- 处理通话状态（idle, calling, incoming, connected）
- 提供通话控制功能（静音、挂断等）

#### MessageLayout.vue 更新
- 集成WebRTC组件
- 添加语音通话按钮
- 处理WebRTC信令消息

### 信令流程

1. **发起通话**
   - 用户A点击通话按钮
   - 发送call-invite信令消息给用户B
   - 用户A进入"正在呼叫"状态

2. **接收通话**
   - 用户B收到call-invite消息
   - 显示来电界面
   - 用户B可选择接听或拒绝

3. **建立连接**
   - 用户B接听后发送call-accept消息
   - 开始WebRTC握手过程（offer/answer/ice-candidate）
   - 建立P2P音频连接

4. **通话中**
   - 显示通话时长
   - 支持静音/取消静音
   - 支持挂断通话

## 使用方法

### 发起语音通话
1. 在聊天界面选择要通话的联系人
2. 点击聊天头部的📞按钮
3. 等待对方接听

### 接听语音通话
1. 收到来电时会自动弹出来电界面
2. 点击"接听"按钮接受通话
3. 点击"拒绝"按钮拒绝通话

### 通话控制
- **静音**: 点击🎤按钮切换静音状态
- **扬声器**: 点击🔊按钮切换扬声器模式
- **挂断**: 点击红色挂断按钮结束通话

## 浏览器兼容性

### 支持的浏览器
- Chrome 56+
- Firefox 44+
- Safari 11+
- Edge 79+

### 权限要求
- 需要用户授权麦克风访问权限
- 建议在HTTPS环境下使用

## 网络要求

### STUN服务器
项目使用Google公共STUN服务器：
- stun:stun.l.google.com:19302
- stun:stun1.l.google.com:19302

### 防火墙配置
- 确保UDP端口可用于WebRTC连接
- 如果在企业网络环境，可能需要配置TURN服务器

## 故障排除

### 常见问题

1. **无法发起通话**
   - 检查麦克风权限是否已授权
   - 确认WebSocket连接正常
   - 检查浏览器控制台错误信息

2. **无法听到对方声音**
   - 检查音频设备设置
   - 确认网络连接稳定
   - 尝试刷新页面重新建立连接

3. **通话质量差**
   - 检查网络带宽
   - 尝试关闭其他占用网络的应用
   - 考虑使用有线网络连接

### 调试信息
打开浏览器开发者工具，查看控制台输出：
- WebRTC连接状态
- ICE候选信息
- 信令消息交换
- 错误信息

## 扩展功能

### 未来可能的改进
1. **视频通话支持**
2. **群组语音通话**
3. **通话录音功能**
4. **通话质量统计**
5. **自定义TURN服务器配置**

### 自定义配置
可以在WebRTCVoiceCall.vue中修改：
- STUN/TURN服务器配置
- 音频编解码器设置
- 连接超时时间
- UI样式和交互

## 安全考虑

1. **端到端加密**: WebRTC默认使用DTLS加密
2. **权限控制**: 需要用户明确授权麦克风访问
3. **信令安全**: 建议在生产环境中使用WSS（WebSocket Secure）

## 部署注意事项

1. **HTTPS要求**: 生产环境必须使用HTTPS
2. **服务器配置**: 确保WebSocket服务器支持WebRTC信令消息
3. **负载均衡**: 考虑WebSocket连接的粘性会话
4. **监控**: 建议添加通话质量和连接成功率监控

---

**注意**: 这是一个基础的WebRTC语音通话实现，在生产环境中使用前请进行充分的测试和优化。