(()=>{"use strict";var e={7143:(e,a,t)=>{var n=t(3751),l=t(641);const s={__name:"App",setup(e){return(e,a)=>{const t=(0,l.g2)("router-view");return(0,l.uX)(),(0,l.Wv)(t)}}},o=s,i=o;var c=t(5220),r=t(33),u=t(953);const v=(0,u.KR)(""),d=(0,u.KR)([]),m=(0,u.KR)([]),p=(0,u.KR)(""),f=(0,u.KR)(""),k=(0,u.KR)({}),g=(0,u.KR)(!1),h=(0,u.KR)(!1),y=(0,u.KR)({fromUsername:"",content:"",from:""}),L=(0,u.KR)(!1),b=(0,u.KR)({fromUsername:"",content:"",from:""}),w=(0,u.KR)(1),C={class:"toast-content"},R={class:"toast-icon"},_={class:"toast-message"},E={__name:"Toast",props:{message:{type:String,required:!0},type:{type:String,default:"info",validator:e=>["info","success","warning","error"].includes(e)},duration:{type:Number,default:3e3},show:{type:Boolean,default:!1}},emits:["close"],setup(e,{emit:a}){const t=e,n=a,s=(0,u.KR)(!1);let o=null;function i(){s.value=!0,o&&clearTimeout(o),o=setTimeout(()=>{c()},t.duration)}function c(){s.value=!1,n("close")}function v(){const e={info:"ℹ️",success:"✅",warning:"⚠️",error:"❌"};return e[t.type]||e.info}return(0,l.wB)(()=>t.show,e=>{e?i():c()}),(a,t)=>s.value?((0,l.uX)(),(0,l.CE)("div",{key:0,class:(0,r.C4)(["toast",e.type])},[(0,l.Lk)("div",C,[(0,l.Lk)("span",R,(0,r.v_)(v()),1),(0,l.Lk)("span",_,(0,r.v_)(e.message),1)])],2)):(0,l.Q3)("",!0)}};var S=t(6262);const T=(0,S.A)(E,[["__scopeId","data-v-61b92383"]]),K=T,x={class:"left-list"},O={class:"my-info"},I={class:"my-name"},U={class:"my-uuid"},j={class:"nav-list"},X={key:0,class:"moment-notification-dot"},A={class:"activated-list"},M={key:0},$={class:"friend-list-title-row"},P={key:0,class:"add-friend-dialog"},F=["disabled"],N={key:1,class:"search-result-list"},Q={key:0,class:"search-error"},B=["onClick"],D={key:0,class:"search-avatar"},J=["src"],W=["innerHTML"],V={key:2,class:"search-avatar"},z={class:"search-nickname"},q={class:"search-uuid"},G=["onClick"],H={class:"friend-avatar"},Y={key:0,class:"avatar-emoji"},Z=["innerHTML"],ee={class:"friend-info"},ae={class:"friend-name"},te={class:"friend-uuid"},ne={key:0,class:"unread-bubble"},le={key:1},se={class:"group-list-title-row"},oe={class:"group-actions"},ie={key:0,class:"create-group-dialog"},ce={class:"create-group-form"},re={class:"form-group"},ue={class:"form-group"},ve={class:"form-group"},de={class:"char-count"},me={class:"form-actions"},pe=["disabled"],fe={key:1,class:"add-group-dialog"},ke=["disabled"],ge=["onClick"],he={class:"group-avatar"},ye={key:0,class:"avatar-emoji"},Le=["innerHTML"],be={class:"group-info"},we={class:"group-name"},Ce={class:"group-uuid"},Re={key:0,class:"group_unread-bubble"},_e={key:2},Ee={class:"moment-list-title-row"},Se={key:0,class:"add-moment-dialog"},Te=["onKeyup"],Ke={class:"moment-actions"},xe={class:"char-count"},Oe=["disabled"],Ie={class:"moment-list"},Ue={class:"moment-header"},je={class:"moment-info"},Xe={class:"moment-author"},Ae={class:"moment-time"},Me={class:"moment-content"},$e={class:"moment-actions"},Pe=["onClick"],Fe=["onClick"],Ne={key:0,class:"moment-comments"},Qe={class:"comment-input-area"},Be=["onUpdate:modelValue","onKeyup"],De={class:"comment-actions"},Je={class:"comment-char-count"},We=["onClick","disabled"],Ve={class:"comments-list"},ze={class:"comment-header"},qe={class:"comment-info"},Ge={class:"comment-author"},He={class:"comment-time"},Ye={class:"comment-content"},Ze={key:0,class:"empty-comments"},ea={key:0,class:"empty-moments"},aa={key:3,class:"friend-request-overlay"},ta={class:"friend-request-dialog"},na={class:"request-buttons"},la={key:4,class:"friend-response-overlay"},sa={class:"friend-response-dialog"},oa={class:"response-buttons"},ia={key:5,class:"settings-overlay"},ca={class:"settings-dialog"},ra={class:"settings-header"},ua={class:"settings-content"},va={class:"settings-tabs"},da={key:0,class:"settings-panel"},ma={class:"form-group"},pa={class:"form-group"},fa={class:"form-group"},ka={class:"form-actions"},ga=["disabled"],ha={key:1,class:"settings-panel"},ya={class:"form-group"},La={class:"form-group"},ba={class:"form-group"},wa={class:"form-actions"},Ca=["disabled"],Ra={key:2,class:"settings-panel"},_a={class:"theme-section"},Ea={class:"theme-options"},Sa={class:"theme-section"},Ta={class:"form-group"},Ka={class:"form-group"},xa={__name:"LeftLayout",setup(e){const a=(0,c.lq)(),t=a.query.session||"default",s=JSON.parse(localStorage.getItem(`userinfo_${t}`)||"{}"),o=s.nickname||"我",i=s.uuid,k=localStorage.getItem(`token_${t}`),C=(0,u.KR)("friend"),R=(0,u.KR)(!1),_=(0,u.KR)(""),E=(0,u.KR)([]),S=(0,u.KR)(!1),T=(0,u.KR)(""),xa=(0,u.KR)(!1),Oa=(0,u.KR)(""),Ia=(0,u.KR)(!1),Ua=(0,u.KR)(""),ja=(0,u.KR)(""),Xa=(0,u.KR)(""),Aa=(0,u.KR)(!1),Ma=(0,u.KR)(!1),$a=(0,u.KR)(!1),Pa=(0,u.KR)(""),Fa=(0,u.KR)("info"),Na=((0,u.KR)(1),(0,u.KR)(!1)),Qa=(0,u.KR)("profile"),Ba=(0,u.KR)(localStorage.getItem("chat-theme")||"light"),Da=(0,u.KR)("true"===localStorage.getItem("chat-auto-theme")),Ja=(0,u.KR)("true"===localStorage.getItem("chat-eye-care")),Wa=(0,u.KR)(!1),Va=(0,u.KR)(!1),za=(0,u.KR)({nickname:s.nickname||"",username:s.username||"",email:s.email||""}),qa=(0,u.KR)({currentPassword:"",newPassword:"",confirmPassword:""}),Ga=(0,u.KR)(!1),Ha=(0,u.KR)(""),Ya=(0,u.KR)(!1),Za=(0,u.KR)([]),et=(0,u.KR)(!1);function at(e,a="info",t=3e3){Pa.value=e,Fa.value=a,$a.value=!0,setTimeout(()=>{$a.value=!1},t)}function tt(e){C.value=e,"friend"===e?ft():"group"===e?kt():"moment"===e&&(Kt(),g.value=!1)}async function nt(){const e=_.value.trim();if(e){S.value=!0,T.value="",E.value=[];try{const a=await fetch(`http://62.234.192.227/v1/api/friend/search?username=${encodeURIComponent(e)}`,{method:"GET",headers:{Authorization:`Bearer ${k}`}});if(!a.ok)throw new Error("网络错误");const t=await a.json();t&&t.data&&t.data.uuid?E.value=[t.data]:T.value="未找到相关用户"}catch(a){T.value="搜索失败："+a.message}finally{S.value=!1}}}function lt(e){const a=async()=>{try{const a=await fetch("http://62.234.192.227/v1/api/friend/addFriend",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({target_user_name:e.username,content:"你好，我是"})}),t=await a.json();if(200!==t.code)throw new Error(t.msg||"添加好友失败");if(201===t.code)throw new Error(t.msg||"好友已存在");at("好友请求已发送","success")}catch(a){T.value="添加失败: "+a.message}};a().then(()=>{d.value.push({uuid:e.uuid,name:e.nickname||e.username}),R.value=!1,_.value="",E.value=[],T.value=""})}function st(){R.value=!1,_.value="",E.value=[],T.value=""}async function ot(){const e=Ua.value.trim(),a=ja.value.trim(),t=Xa.value.trim();if(e)if(a){Aa.value=!0;try{const n=await fetch("http://62.234.192.227/v1/api/group/createGroup",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({group_name:e,group_type:a,description:t})});if(!n.ok)throw new Error("网络错误");const l=await n.json();if(0!==l.code)throw new Error(l.msg||"创建失败");console.log(l),m.value.push({uuid:l.data.group_id,name:l.data.group_name,type:a,description:t,unread:0}),at("群组创建成功","success"),ct()}catch(n){at("创建群组失败: "+n.message,"error")}finally{Aa.value=!1}}else at("请选择群组类型","warning");else at("请输入群组名称","warning")}async function it(){const e=Oa.value.trim();if(e){Ma.value=!0;try{const a=await fetch("http://62.234.192.227/v1/api/group/joinGroup",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({group_name:e})});if(!a.ok)throw new Error("网络错误");const t=await a.json();if(0!==t.code)throw new Error(t.msg||"加入失败");console.log(t),m.value.push({uuid:t.data.group_uuid,name:t.data.group_name,unread:0}),at("成功加入群聊","success"),rt()}catch(a){at("加入群聊失败: "+a.message,"error")}finally{Ma.value=!1}}else at("请输入群聊名称","warning")}function ct(){Ia.value=!1,Ua.value="",ja.value="",Xa.value=""}function rt(){xa.value=!1,Oa.value=""}function ut(e){v.value=e.uuid,w.value=1,f.value=e.uuid,e.unread=0,p.value=e.name,dt()}function vt(e){console.log(e),v.value=e.uuid,w.value=2,f.value=e.uuid,e.unread=0,p.value=e.name,dt()}function dt(){const e={};d.value.forEach(a=>{a.unread>0&&(e[a.uuid]=a.unread)}),m.value.forEach(a=>{a.unread>0&&(e[a.uuid]=a.unread)}),localStorage.setItem(`unreadCounts_${t}`,JSON.stringify(e))}async function mt(e){try{await fetch("http://62.234.192.227/v1/api/friend/handleRequest",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({status:e?1:0,target_uuid:y.value.from})})}catch(a){at("操作失败: "+a.message,"error")}finally{h.value=!1}}async function pt(){try{await fetch("http://62.234.192.227/v1/api/friend/handleResponse",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({status:1,target_uuid:b.value.from})});ft()}catch(e){at("操作失败: "+e.message,"error")}finally{L.value=!1}}async function ft(){try{const e=await fetch("http://62.234.192.227/v1/api/friend/getFriendList",{method:"GET",headers:{Authorization:`Bearer ${k}`}}),a=await e.json(),n=JSON.parse(localStorage.getItem(`unreadCounts_${t}`)||"{}");d.value=a.data.map(e=>({name:e.friend_nickname,uuid:e.friend_uuid,unread:n[e.friend_uuid]||0}))}catch(e){}}async function kt(){try{const e=await fetch("http://62.234.192.227/v1/api/group/getGroupList",{method:"GET",headers:{Authorization:`Bearer ${k}`}}),a=await e.json(),n=JSON.parse(localStorage.getItem(`unreadCounts_${t}`)||"{}");m.value=a.data.map(e=>({uuid:e.group_uuid,name:e.group_name,unread:n[e.group_uuid]||0}))}catch(e){}}async function gt(){if(za.value.nickname.trim()){Wa.value=!0;try{const e=await fetch("http://62.234.192.227/v1/api/profile/updateProfile",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({username:za.value.username,nickname:za.value.nickname,email:za.value.email,avatar:za.value.avatar||""})}),a=await e.json();0==a.code?at("更新成功","success"):at("更新失败","error")}catch(e){at("更新失败: "+e.message,"error")}finally{Wa.value=!1}}else at("昵称不能为空","warning")}async function ht(){if(qa.value.currentPassword)if(qa.value.newPassword)if(qa.value.newPassword.length<6)at("新密码长度不能少于6位","warning");else if(qa.value.newPassword===qa.value.confirmPassword){Va.value=!0;try{const e=await fetch("http://62.234.192.227/v1/api/user/updatePassword",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({currentPassword:qa.value.currentPassword,newPassword:qa.value.newPassword})}),a=await e.json();if(200!==a.code)throw new Error(a.msg||"修改失败");at("密码修改成功","success"),Lt()}catch(e){at("修改失败: "+e.message,"error")}finally{Va.value=!1}}else at("两次输入的新密码不一致","warning");else at("请输入新密码","warning");else at("请输入当前密码","warning")}function yt(){za.value={nickname:s.nickname||"",username:s.username||"",email:s.email||""}}function Lt(){qa.value={currentPassword:"",newPassword:"",confirmPassword:""}}function bt(e){Ba.value=e,localStorage.setItem("chat-theme",e),Rt(e)}function wt(){if(localStorage.setItem("chat-auto-theme",Da.value.toString()),Da.value){const e=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";bt(e)}}function Ct(){localStorage.setItem("chat-eye-care",Ja.value.toString()),_t()}function Rt(e){const a=document.documentElement;a.setAttribute("data-theme",e),a.classList.remove("light-theme","dark-theme","eye-care-theme"),a.classList.add(`${e}-theme`)}function _t(){const e=document.documentElement;Ja.value?e.classList.add("eye-care-enhanced"):e.classList.remove("eye-care-enhanced")}function Et(){const e=window.matchMedia("(prefers-color-scheme: dark)");e.addEventListener("change",e=>{if(Da.value){const a=e.matches?"dark":"light";bt(a)}})}async function St(){const e=Ha.value.trim();if(e){Ya.value=!0;try{await fetch("http://62.234.192.227/v1/api/moment/createMoment",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({content:e})});const a={id:Date.now(),author:o,content:e,timestamp:(new Date).toISOString()};Za.value.unshift(a);const n=JSON.parse(localStorage.getItem(`moments_${t}`)||"[]");n.unshift(a),localStorage.setItem(`moments_${t}`,JSON.stringify(n)),Tt()}catch(a){at("发布失败: "+a.message,"error")}finally{Ya.value=!1}}else at("请输入动态内容","warning")}function Tt(){Ga.value=!1,Ha.value=""}async function Kt(){try{const e=await fetch("http://62.234.192.227/v1/api/moment/list",{method:"GET",headers:{Authorization:`Bearer ${k}`}}),a=await e.json();0===a.code&&(Za.value=a.data.map(e=>({moment_id:e.moment_id,user_id:e.user_id,author:e.username,content:e.content,likes:e.like_count,comments:e.comment_list,timestamp:e.create_time})))}catch(e){at("获取动态列表失败: "+e.message,"error")}}function xt(e){const a=new Date(e),t=new Date,n=t-a;return n<6e4?"刚刚":n<36e5?Math.floor(n/6e4)+"分钟前":n<864e5?Math.floor(n/36e5)+"小时前":n<6048e5?Math.floor(n/864e5)+"天前":a.toLocaleDateString()}async function Ot(e){console.log("点赞动态2:",e["moment_id"]),console.log("moment_id类型:",typeof e["moment_id"]);const a=parseInt(e["moment_id"]);console.log("parseInt后的值:",a),console.log("parseInt后的类型:",typeof a);try{const t={moment_id:a},n=await fetch("http://62.234.192.227/v1/api/comment/like",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify(t)}),l=await n.json();if(0!==l.code)throw new Error(l.msg||"你已经点赞过了");at("点赞成功","success"),e.likes||(e.likes=0),e.likes++,console.log("点赞动态:",e)}catch(t){at("点赞失败: "+t.message,"error")}}function It(e){e.showComments=!e.showComments,e.showComments&&!e.comments&&(e.comments=[],e.newComment="",jt(e))}async function Ut(e){const a=e.newComment?.trim();if(a){et.value=!0;try{const t=parseInt(e["moment_id"]||e.id),n=await fetch("http://62.234.192.227/v1/api/comment/create",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({moment_id:t,content:a})}),l=await n.json();if(0!==l.code)throw new Error(l.msg||"评论发布失败");{const t={id:Date.now(),author:o,content:a,timestamp:(new Date).toISOString()};e.comments||(e.comments=[]),e.comments.unshift(t),e.newComment=""}}catch(t){at("评论发布失败: "+t.message,"error")}finally{et.value=!1}}else at("请输入评论内容","warning")}async function jt(e){try{const a=parseInt(e["moment_id"]||e.id),t=await fetch(`http://62.234.192.227/v1/api/comment/list?moment_id=${a}`,{method:"GET",headers:{Authorization:`Bearer ${k}`}}),n=await t.json();0===n.code&&(e.comments=n.data.map(e=>({id:e.comment_id,author:e.username,content:e.content,timestamp:e.create_time})))}catch(a){at("获取评论列表失败: "+a.message,"error"),e.comments=[]}}return(0,l.sV)(async()=>{ft(),kt(),Rt(Ba.value),_t(),Et()}),(e,a)=>((0,l.uX)(),(0,l.CE)(l.FK,null,[(0,l.Lk)("div",x,[(0,l.Lk)("div",O,[a[33]||(a[33]=(0,l.Lk)("div",{class:"my-avatar"},[(0,l.Lk)("svg",{viewBox:"0 0 36 36",fill:"none",role:"img",xmlns:"",width:"50",height:"50"},[(0,l.Lk)("mask",{id:"«R47rrlb»",maskUnits:"userSpaceOnUse",x:"0",y:"0",width:"36",height:"36"},[(0,l.Lk)("rect",{width:"36",height:"36",rx:"72",fill:"#FFFFFF"})]),(0,l.Lk)("g",{mask:"url(#«R47rrlb»)"},[(0,l.Lk)("rect",{width:"36",height:"36",fill:"#49007e"}),(0,l.Lk)("rect",{x:"0",y:"0",width:"36",height:"36",transform:"translate(7 1) rotate(53 18 18) scale(1.2)",fill:"#ff7d10",rx:"6"}),(0,l.Lk)("g",{transform:"translate(3.5 -4) rotate(3 18 18)"},[(0,l.Lk)("path",{d:"M15 21c2 1 4 1 6 0",stroke:"#000000",fill:"none","stroke-linecap":"round"}),(0,l.Lk)("rect",{x:"11",y:"14",width:"1.5",height:"2",rx:"1",stroke:"none",fill:"#000000"}),(0,l.Lk)("rect",{x:"23",y:"14",width:"1.5",height:"2",rx:"1",stroke:"none",fill:"#000000"})])])])],-1)),(0,l.Lk)("div",I,(0,r.v_)((0,u.R1)(o)),1),(0,l.Lk)("div",U,(0,r.v_)((0,u.R1)(i)),1)]),(0,l.Lk)("div",j,[(0,l.Lk)("div",{class:(0,r.C4)(["nav-item",{active:"friend"===C.value}]),onClick:a[0]||(a[0]=e=>tt("friend"))},a[34]||(a[34]=[(0,l.Lk)("span",{class:"nav-icon"},null,-1),(0,l.eW)(" 好友 ",-1)]),2),(0,l.Lk)("div",{class:(0,r.C4)(["nav-item",{active:"group"===C.value}]),onClick:a[1]||(a[1]=e=>tt("group"))},a[35]||(a[35]=[(0,l.Lk)("span",{class:"nav-icon"},null,-1),(0,l.eW)(" 群组 ",-1)]),2),(0,l.Lk)("div",{class:(0,r.C4)(["nav-item",{active:"moment"===C.value}]),onClick:a[2]||(a[2]=e=>tt("moment"))},[a[36]||(a[36]=(0,l.Lk)("span",{class:"nav-icon"},null,-1)),a[37]||(a[37]=(0,l.eW)("此刻 ",-1)),(0,u.R1)(g)?((0,l.uX)(),(0,l.CE)("div",X)):(0,l.Q3)("",!0)],2),(0,l.Lk)("div",{class:"nav-item",onClick:a[3]||(a[3]=e=>Na.value=!0)},a[38]||(a[38]=[(0,l.Lk)("span",{class:"nav-icon"},null,-1),(0,l.eW)("设置",-1)]))])]),(0,l.Lk)("div",A,["friend"===C.value?((0,l.uX)(),(0,l.CE)("div",M,[(0,l.Lk)("div",$,[a[39]||(a[39]=(0,l.Lk)("div",{class:"friend-list-title"},"好友",-1)),(0,l.Lk)("button",{class:"add-friend-btn",onClick:a[4]||(a[4]=e=>R.value=!0)},"添加好友")]),R.value?((0,l.uX)(),(0,l.CE)("div",P,[(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":a[5]||(a[5]=e=>_.value=e),placeholder:"Username",class:"add-friend-input",onKeyup:(0,n.jR)(nt,["enter"])},null,544),[[n.Jo,_.value]]),(0,l.Lk)("button",{class:"add-friend-confirm",onClick:nt,disabled:S.value},"Search",8,F),(0,l.Lk)("button",{class:"add-friend-cancel",onClick:st},"Cancel")])):(0,l.Q3)("",!0),R.value&&(E.value.length>0||T.value)?((0,l.uX)(),(0,l.CE)("div",N,[T.value?((0,l.uX)(),(0,l.CE)("div",Q,(0,r.v_)(T.value),1)):(0,l.Q3)("",!0),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(E.value,e=>((0,l.uX)(),(0,l.CE)("div",{key:e.uuid,class:"search-result-item",onClick:a=>lt(e)},[e.avatar&&(e.avatar.endsWith(".png")||e.avatar.endsWith(".jpg")||e.avatar.endsWith(".jpeg")||e.avatar.endsWith(".gif"))?((0,l.uX)(),(0,l.CE)("span",D,[(0,l.Lk)("img",{src:"/avatars/"+e.avatar,alt:"avatar",style:{width:"32px",height:"32px","border-radius":"50%","object-fit":"cover"}},null,8,J)])):e.avatar&&e.avatar.startsWith("<svg")?((0,l.uX)(),(0,l.CE)("span",{key:1,class:"search-avatar",innerHTML:e.avatar},null,8,W)):((0,l.uX)(),(0,l.CE)("span",V,(0,r.v_)(e.avatar||"😀"),1)),(0,l.Lk)("span",z,(0,r.v_)(e.nickname||e.username),1),(0,l.Lk)("span",q,"("+(0,r.v_)(e.uuid)+")",1),a[40]||(a[40]=(0,l.Lk)("span",{class:"search-add"},"点击添加",-1))],8,B))),128))])):(0,l.Q3)("",!0),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)((0,u.R1)(d),e=>((0,l.uX)(),(0,l.CE)("div",{key:e.uuid,class:(0,r.C4)(["friend-item",{active:e.uuid===(0,u.R1)(v)}]),onClick:a=>ut(e)},[(0,l.Lk)("div",H,["emoji"===e.avatarType?((0,l.uX)(),(0,l.CE)("span",Y,(0,r.v_)(e.avatar),1)):"svg"===e.avatarType?((0,l.uX)(),(0,l.CE)("span",{key:1,innerHTML:e.avatar},null,8,Z)):(0,l.Q3)("",!0)]),(0,l.Lk)("div",ee,[(0,l.Lk)("div",ae,(0,r.v_)(e.name),1),(0,l.Lk)("div",te,(0,r.v_)(e.uuid),1)]),e.unread>0?((0,l.uX)(),(0,l.CE)("div",ne,(0,r.v_)(e.unread),1)):(0,l.Q3)("",!0)],10,G))),128))])):"group"===C.value?((0,l.uX)(),(0,l.CE)("div",le,[(0,l.Lk)("div",se,[a[41]||(a[41]=(0,l.Lk)("div",{class:"group-list-title"},"群聊",-1)),(0,l.Lk)("div",oe,[(0,l.Lk)("button",{class:"create-group-btn",onClick:a[6]||(a[6]=e=>Ia.value=!0)},"＋创建群组"),(0,l.Lk)("button",{class:"add-group-btn",onClick:a[7]||(a[7]=e=>xa.value=!0)},"＋加入群聊")])]),Ia.value?((0,l.uX)(),(0,l.CE)("div",ie,[(0,l.Lk)("div",ce,[(0,l.Lk)("div",re,[a[42]||(a[42]=(0,l.Lk)("label",null,"群组名称：",-1)),(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":a[8]||(a[8]=e=>Ua.value=e),placeholder:"输入新群组名称",class:"create-group-input"},null,512),[[n.Jo,Ua.value]])]),(0,l.Lk)("div",ue,[a[44]||(a[44]=(0,l.Lk)("label",null,"群组类型：",-1)),(0,l.bo)((0,l.Lk)("select",{"onUpdate:modelValue":a[9]||(a[9]=e=>ja.value=e),class:"create-group-select"},a[43]||(a[43]=[(0,l.Fv)('<option value="" data-v-c166fb62>请选择群组类型</option><option value="游戏" data-v-c166fb62>游戏</option><option value="体育" data-v-c166fb62>体育</option><option value="新闻" data-v-c166fb62>新闻</option><option value="学习" data-v-c166fb62>学习</option><option value="工作" data-v-c166fb62>工作</option><option value="娱乐" data-v-c166fb62>娱乐</option><option value="生活" data-v-c166fb62>生活</option><option value="技术" data-v-c166fb62>技术</option><option value="其他" data-v-c166fb62>其他</option>',10)]),512),[[n.u1,ja.value]])]),(0,l.Lk)("div",ve,[a[45]||(a[45]=(0,l.Lk)("label",null,"群组描述：",-1)),(0,l.bo)((0,l.Lk)("textarea",{"onUpdate:modelValue":a[10]||(a[10]=e=>Xa.value=e),placeholder:"请输入群组描述（最多200字）",class:"create-group-textarea",maxlength:"200"},null,512),[[n.Jo,Xa.value]]),(0,l.Lk)("div",de,(0,r.v_)(Xa.value.length)+"/200",1)]),(0,l.Lk)("div",me,[(0,l.Lk)("button",{class:"create-group-confirm",onClick:ot,disabled:Aa.value||!Ua.value.trim()||!ja.value},"创建",8,pe),(0,l.Lk)("button",{class:"create-group-cancel",onClick:ct},"取消")])])])):(0,l.Q3)("",!0),xa.value?((0,l.uX)(),(0,l.CE)("div",fe,[(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":a[11]||(a[11]=e=>Oa.value=e),placeholder:"输入要加入的群聊名称",class:"add-group-input",onKeyup:(0,n.jR)(it,["enter"])},null,544),[[n.Jo,Oa.value]]),(0,l.Lk)("button",{class:"add-group-confirm",onClick:it,disabled:Ma.value},"加入",8,ke),(0,l.Lk)("button",{class:"add-group-cancel",onClick:rt},"取消")])):(0,l.Q3)("",!0),((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)((0,u.R1)(m),e=>((0,l.uX)(),(0,l.CE)("div",{key:e.uuid,class:(0,r.C4)(["group-item",{active:e.uuid===(0,u.R1)(v)}]),onClick:a=>vt(e)},[(0,l.Lk)("div",he,["emoji"===e.avatarType?((0,l.uX)(),(0,l.CE)("span",ye,(0,r.v_)(e.avatar),1)):"svg"===e.avatarType?((0,l.uX)(),(0,l.CE)("span",{key:1,innerHTML:e.avatar},null,8,Le)):(0,l.Q3)("",!0)]),(0,l.Lk)("div",be,[(0,l.Lk)("div",we,(0,r.v_)(e.name),1),(0,l.Lk)("div",Ce,(0,r.v_)(e.uuid),1)]),e.unread>0?((0,l.uX)(),(0,l.CE)("div",Re,(0,r.v_)(e.unread),1)):(0,l.Q3)("",!0)],10,ge))),128))])):"moment"===C.value?((0,l.uX)(),(0,l.CE)("div",_e,[(0,l.Lk)("div",Ee,[a[46]||(a[46]=(0,l.Lk)("div",{class:"moment-list-title"},"此刻",-1)),(0,l.Lk)("button",{class:"add-moment-btn",onClick:a[12]||(a[12]=e=>Ga.value=!0)},"发布动态")]),Ga.value?((0,l.uX)(),(0,l.CE)("div",Se,[(0,l.bo)((0,l.Lk)("textarea",{"onUpdate:modelValue":a[13]||(a[13]=e=>Ha.value=e),placeholder:"分享你此刻在做什么...",class:"add-moment-textarea",onKeyup:(0,n.jR)((0,n.D$)(St,["ctrl"]),["enter"]),maxlength:"200"},null,40,Te),[[n.Jo,Ha.value]]),(0,l.Lk)("div",Ke,[(0,l.Lk)("span",xe,(0,r.v_)(Ha.value.length)+"/200",1),(0,l.Lk)("button",{class:"publish-moment-btn",onClick:St,disabled:!Ha.value.trim()||Ya.value},"发布",8,Oe),(0,l.Lk)("button",{class:"cancel-moment-btn",onClick:Tt},"取消")])])):(0,l.Q3)("",!0),(0,l.Lk)("div",Ie,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(Za.value,e=>((0,l.uX)(),(0,l.CE)("div",{key:e.id,class:"moment-item"},[(0,l.Lk)("div",Ue,[a[47]||(a[47]=(0,l.Lk)("div",{class:"moment-avatar"},[(0,l.Lk)("svg",{viewBox:"0 0 36 36",fill:"none",role:"img",xmlns:"",width:"32",height:"32"},[(0,l.Lk)("mask",{id:"moment-avatar",maskUnits:"userSpaceOnUse",x:"0",y:"0",width:"36",height:"36"},[(0,l.Lk)("rect",{width:"36",height:"36",rx:"72",fill:"#FFFFFF"})]),(0,l.Lk)("g",{mask:"url(#moment-avatar)"},[(0,l.Lk)("rect",{width:"36",height:"36",fill:"#49007e"}),(0,l.Lk)("rect",{x:"0",y:"0",width:"36",height:"36",transform:"translate(7 1) rotate(53 18 18) scale(1.2)",fill:"#ff7d10",rx:"6"})])])],-1)),(0,l.Lk)("div",je,[(0,l.Lk)("div",Xe,(0,r.v_)(e.author),1),(0,l.Lk)("div",Ae,(0,r.v_)(xt(e.timestamp)),1)])]),(0,l.Lk)("div",Me,(0,r.v_)(e.content),1),(0,l.Lk)("div",$e,[(0,l.Lk)("button",{class:"moment-action-btn",onClick:a=>Ot(e)},[a[48]||(a[48]=(0,l.Lk)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[(0,l.Lk)("path",{d:"M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"})],-1)),(0,l.Lk)("span",null,(0,r.v_)(e.likes||0),1)],8,Pe),(0,l.Lk)("button",{class:"moment-action-btn",onClick:a=>It(e)},[a[49]||(a[49]=(0,l.Lk)("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2"},[(0,l.Lk)("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"})],-1)),(0,l.Lk)("span",null,(0,r.v_)(e.comments?.length||0),1)],8,Fe)]),e.showComments?((0,l.uX)(),(0,l.CE)("div",Ne,[(0,l.Lk)("div",Qe,[(0,l.bo)((0,l.Lk)("textarea",{"onUpdate:modelValue":a=>e.newComment=a,placeholder:"写下你的评论...",class:"comment-input",onKeyup:(0,n.jR)((0,n.D$)(a=>Ut(e),["ctrl"]),["enter"]),maxlength:"500"},null,40,Be),[[n.Jo,e.newComment]]),(0,l.Lk)("div",De,[(0,l.Lk)("span",Je,(0,r.v_)((e.newComment||"").length)+"/500",1),(0,l.Lk)("button",{class:"submit-comment-btn",onClick:a=>Ut(e),disabled:!e.newComment?.trim()||et.value}," 发布评论 ",8,We)])]),(0,l.Lk)("div",Ve,[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(e.comments,e=>((0,l.uX)(),(0,l.CE)("div",{key:e.id,class:"comment-item"},[(0,l.Lk)("div",ze,[a[50]||(a[50]=(0,l.Lk)("div",{class:"comment-avatar"},[(0,l.Lk)("svg",{viewBox:"0 0 36 36",fill:"none",role:"img",xmlns:"",width:"24",height:"24"},[(0,l.Lk)("mask",{id:"comment-avatar",maskUnits:"userSpaceOnUse",x:"0",y:"0",width:"36",height:"36"},[(0,l.Lk)("rect",{width:"36",height:"36",rx:"72",fill:"#FFFFFF"})]),(0,l.Lk)("g",{mask:"url(#comment-avatar)"},[(0,l.Lk)("rect",{width:"36",height:"36",fill:"#49007e"}),(0,l.Lk)("rect",{x:"0",y:"0",width:"36",height:"36",transform:"translate(7 1) rotate(53 18 18) scale(1.2)",fill:"#ff7d10",rx:"6"})])])],-1)),(0,l.Lk)("div",qe,[(0,l.Lk)("div",Ge,(0,r.v_)(e.author),1),(0,l.Lk)("div",He,(0,r.v_)(xt(e.timestamp)),1)])]),(0,l.Lk)("div",Ye,(0,r.v_)(e.content),1)]))),128)),e.comments&&0!==e.comments.length?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",Ze,a[51]||(a[51]=[(0,l.Lk)("div",{class:"empty-comment-text"},"还没有评论，快来抢沙发吧！",-1)])))])])):(0,l.Q3)("",!0)]))),128)),0===Za.value.length?((0,l.uX)(),(0,l.CE)("div",ea,a[52]||(a[52]=[(0,l.Lk)("div",{class:"empty-icon"},"📝",-1),(0,l.Lk)("div",{class:"empty-text"},"还没有动态，快来发布第一条吧！",-1)]))):(0,l.Q3)("",!0)])])):(0,l.Q3)("",!0),(0,u.R1)(h)?((0,l.uX)(),(0,l.CE)("div",aa,[(0,l.Lk)("div",ta,[a[53]||(a[53]=(0,l.Lk)("h3",null,"好友请求",-1)),(0,l.Lk)("p",null,"来自："+(0,r.v_)((0,u.R1)(y).fromUsername),1),(0,l.Lk)("p",null,"留言："+(0,r.v_)((0,u.R1)(y).content),1),(0,l.Lk)("div",na,[(0,l.Lk)("button",{onClick:a[14]||(a[14]=e=>mt(!0)),class:"accept-btn"},"接受"),(0,l.Lk)("button",{onClick:a[15]||(a[15]=e=>mt(!1)),class:"reject-btn"},"拒绝")])])])):(0,l.Q3)("",!0),(0,u.R1)(L)?((0,l.uX)(),(0,l.CE)("div",la,[(0,l.Lk)("div",sa,[a[54]||(a[54]=(0,l.Lk)("h3",null,"好友请求回复",-1)),(0,l.Lk)("p",null,"来自："+(0,r.v_)((0,u.R1)(b).fromUsername),1),(0,l.Lk)("p",null,"留言："+(0,r.v_)((0,u.R1)(b).content),1),(0,l.Lk)("div",oa,[(0,l.Lk)("button",{onClick:a[16]||(a[16]=e=>pt()),class:"ok-btn"},"知道了")])])])):(0,l.Q3)("",!0),Na.value?((0,l.uX)(),(0,l.CE)("div",ia,[(0,l.Lk)("div",ca,[(0,l.Lk)("div",ra,[a[55]||(a[55]=(0,l.Lk)("h3",null,"设置",-1)),(0,l.Lk)("button",{class:"close-btn",onClick:a[17]||(a[17]=e=>Na.value=!1)},"×")]),(0,l.Lk)("div",ua,[(0,l.Lk)("div",va,[(0,l.Lk)("button",{class:(0,r.C4)(["tab-btn",{active:"profile"===Qa.value}]),onClick:a[18]||(a[18]=e=>Qa.value="profile")}," 个人信息 ",2),(0,l.Lk)("button",{class:(0,r.C4)(["tab-btn",{active:"password"===Qa.value}]),onClick:a[19]||(a[19]=e=>Qa.value="password")}," 修改密码 ",2),(0,l.Lk)("button",{class:(0,r.C4)(["tab-btn",{active:"theme"===Qa.value}]),onClick:a[20]||(a[20]=e=>Qa.value="theme")}," 主题设置 ",2)]),"profile"===Qa.value?((0,l.uX)(),(0,l.CE)("div",da,[(0,l.Lk)("div",ma,[a[56]||(a[56]=(0,l.Lk)("label",null,"昵称：",-1)),(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":a[21]||(a[21]=e=>za.value.nickname=e),type:"text",class:"form-input",placeholder:"请输入昵称"},null,512),[[n.Jo,za.value.nickname]])]),(0,l.Lk)("div",pa,[a[57]||(a[57]=(0,l.Lk)("label",null,"用户名：",-1)),(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":a[22]||(a[22]=e=>za.value.username=e),type:"text",class:"form-input",placeholder:"请输入用户名"},null,512),[[n.Jo,za.value.username]])]),(0,l.Lk)("div",fa,[a[58]||(a[58]=(0,l.Lk)("label",null,"邮箱：",-1)),(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":a[23]||(a[23]=e=>za.value.email=e),type:"email",class:"form-input",placeholder:"请输入邮箱"},null,512),[[n.Jo,za.value.email]])]),(0,l.Lk)("div",ka,[(0,l.Lk)("button",{onClick:gt,class:"save-btn",disabled:Wa.value},"保存",8,ga),(0,l.Lk)("button",{onClick:yt,class:"cancel-btn"},"重置")])])):(0,l.Q3)("",!0),"password"===Qa.value?((0,l.uX)(),(0,l.CE)("div",ha,[(0,l.Lk)("div",ya,[a[59]||(a[59]=(0,l.Lk)("label",null,"当前密码：",-1)),(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":a[24]||(a[24]=e=>qa.value.currentPassword=e),type:"password",class:"form-input",placeholder:"请输入当前密码"},null,512),[[n.Jo,qa.value.currentPassword]])]),(0,l.Lk)("div",La,[a[60]||(a[60]=(0,l.Lk)("label",null,"新密码：",-1)),(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":a[25]||(a[25]=e=>qa.value.newPassword=e),type:"password",class:"form-input",placeholder:"请输入新密码"},null,512),[[n.Jo,qa.value.newPassword]])]),(0,l.Lk)("div",ba,[a[61]||(a[61]=(0,l.Lk)("label",null,"确认新密码：",-1)),(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":a[26]||(a[26]=e=>qa.value.confirmPassword=e),type:"password",class:"form-input",placeholder:"请再次输入新密码"},null,512),[[n.Jo,qa.value.confirmPassword]])]),(0,l.Lk)("div",wa,[(0,l.Lk)("button",{onClick:ht,class:"save-btn",disabled:Va.value},"修改密码",8,Ca),(0,l.Lk)("button",{onClick:Lt,class:"cancel-btn"},"重置")])])):(0,l.Q3)("",!0),"theme"===Qa.value?((0,l.uX)(),(0,l.CE)("div",Ra,[(0,l.Lk)("div",_a,[a[65]||(a[65]=(0,l.Lk)("h4",null,"外观模式",-1)),(0,l.Lk)("div",Ea,[(0,l.Lk)("div",{class:(0,r.C4)(["theme-option",{active:"light"===Ba.value}]),onClick:a[27]||(a[27]=e=>bt("light"))},a[62]||(a[62]=[(0,l.Lk)("div",{class:"theme-preview light-preview"},[(0,l.Lk)("div",{class:"preview-header"}),(0,l.Lk)("div",{class:"preview-content"})],-1),(0,l.Lk)("span",null,"浅色模式",-1)]),2),(0,l.Lk)("div",{class:(0,r.C4)(["theme-option",{active:"dark"===Ba.value}]),onClick:a[28]||(a[28]=e=>bt("dark"))},a[63]||(a[63]=[(0,l.Lk)("div",{class:"theme-preview dark-preview"},[(0,l.Lk)("div",{class:"preview-header"}),(0,l.Lk)("div",{class:"preview-content"})],-1),(0,l.Lk)("span",null,"深色模式",-1)]),2),(0,l.Lk)("div",{class:(0,r.C4)(["theme-option",{active:"eye-care"===Ba.value}]),onClick:a[29]||(a[29]=e=>bt("eye-care"))},a[64]||(a[64]=[(0,l.Lk)("div",{class:"theme-preview eye-care-preview"},[(0,l.Lk)("div",{class:"preview-header"}),(0,l.Lk)("div",{class:"preview-content"})],-1),(0,l.Lk)("span",null,"护眼模式",-1)]),2)])]),(0,l.Lk)("div",Sa,[a[69]||(a[69]=(0,l.Lk)("h4",null,"个性化设置",-1)),(0,l.Lk)("div",Ta,[(0,l.Lk)("label",null,[(0,l.bo)((0,l.Lk)("input",{type:"checkbox","onUpdate:modelValue":a[30]||(a[30]=e=>Da.value=e),onChange:wt},null,544),[[n.lH,Da.value]]),a[66]||(a[66]=(0,l.eW)(" 跟随系统主题 ",-1))])]),(0,l.Lk)("div",Ka,[(0,l.Lk)("label",null,[(0,l.bo)((0,l.Lk)("input",{type:"checkbox","onUpdate:modelValue":a[31]||(a[31]=e=>Ja.value=e),onChange:Ct},null,544),[[n.lH,Ja.value]]),a[67]||(a[67]=(0,l.eW)(" 护眼模式增强 ",-1))]),a[68]||(a[68]=(0,l.Lk)("small",null,"降低蓝光，减少眼部疲劳",-1))])])])):(0,l.Q3)("",!0)])])])):(0,l.Q3)("",!0)]),(0,l.bF)(K,{message:Pa.value,type:Fa.value,show:$a.value,onClose:a[32]||(a[32]=e=>$a.value=!1)},null,8,["message","type","show"])],64))}},Oa=(0,S.A)(xa,[["__scopeId","data-v-c166fb62"]]),Ia=Oa;var Ua=t(2549),ja=t.n(Ua);function Xa(e){const a=["B","KB","MB","GB"];let t=e,n=0;while(t>=1024&&n<a.length-1)t/=1024,n++;return`${t.toFixed(0===n?0:1)} ${a[n]}`}const Aa=["😄","👧","🦄","🐱","🐶","🐼","🐸","🐵","🐯","🐰","🦊","🐻","🐮","🐷","🐔","🦁"];let Ma=null;const $a=(0,u.KR)(!1);function Pa(e="default",a,t,n){const l=localStorage.getItem(`token_${e}`);if(!l)return console.error("No token found for session:",e),void($a.value=!1);const s=`ws://62.234.192.227/v1/api/webSocket/connect?token=${l}`;Ma=new WebSocket(s),Ma.binaryType="arraybuffer",Ma.onopen=()=>{$a.value=!0,setInterval(()=>{if(Ma&&Ma.readyState===WebSocket.OPEN){const e={to:t,type:"ping",messageType:1},a=n.verify(e);if(a)return void console.error("Message verification failed:",a);const l=n.encode(n.create(e)).finish();Ma.send(l)}},3e4)},Ma.onclose=()=>{$a.value=!1},a&&(Ma.onmessage=a)}function Fa(){return Ma}function Na(){Ma&&Ma.close()}const Qa={key:0,class:"voice-call-overlay"},Ba={key:0,class:"call-interface incoming-call"},Da={class:"caller-info"},Ja={key:1,class:"call-interface outgoing-call"},Wa={class:"caller-info"},Va={key:2,class:"call-interface active-call"},za={class:"caller-info"},qa={class:"call-controls"},Ga={__name:"WebRTCVoiceCall",props:{myUuid:String,myName:String,messageType:Object},emits:["call-ended","call-started"],setup(e,{expose:a,emit:t}){const n=e,s=t,o=(0,u.KR)(!1),i=(0,u.KR)("idle"),c=(0,u.KR)(""),v=(0,u.KR)(""),d=(0,u.KR)(""),m=(0,u.KR)(!1),p=(0,u.KR)(!1),f=(0,u.KR)(0),k=(0,u.KR)(null),g=(0,u.KR)(null),h=(0,u.KR)(null),y=(0,u.KR)(null),L=((0,u.KR)([]),{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]}),b=(0,l.EW)(()=>e=>{const a=Math.floor(e/60),t=e%60;return`${a.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`});async function w(){try{g.value=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),y.value=new RTCPeerConnection(L),g.value.getTracks().forEach(e=>{y.value.addTrack(e,g.value)}),y.value.ontrack=e=>{h.value=e.streams[0],x()},y.value.onicecandidate=e=>{e.candidate&&I({type:"ice-candidate",candidate:e.candidate})},y.value.onconnectionstatechange=()=>{console.log("Connection state:",y.value.connectionState),"connected"===y.value.connectionState?(i.value="connected",O()):"disconnected"!==y.value.connectionState&&"failed"!==y.value.connectionState||S()}}catch(e){console.error("初始化WebRTC失败:",e),alert("无法访问麦克风，请检查权限设置")}}async function C(e,a){d.value=e,v.value=a,i.value="calling",o.value=!0,await w(),I({type:"call-invite",from:n.myUuid,fromName:n.myName,to:e}),s("call-started")}async function R(){await w(),I({type:"call-accept",from:n.myUuid,to:d.value}),i.value="connected"}function _(){I({type:"call-reject",from:n.myUuid,to:d.value}),S()}function E(){I({type:"call-hangup",from:n.myUuid,to:d.value}),S()}function S(){k.value&&(clearInterval(k.value),k.value=null),g.value&&(g.value.getTracks().forEach(e=>e.stop()),g.value=null),y.value&&(y.value.close(),y.value=null),i.value="idle",o.value=!1,f.value=0,c.value="",v.value="",d.value="",m.value=!1,p.value=!1,s("call-ended")}function T(){if(g.value){const e=g.value.getAudioTracks()[0];e&&(e.enabled=!e.enabled,m.value=!e.enabled)}}function K(){p.value=!p.value}function x(){if(h.value){const e=new Audio;e.srcObject=h.value,e.play().catch(console.error)}}function O(){k.value=setInterval(()=>{f.value++},1e3)}function I(e){const a=Fa();if(console.log("ws:",a),console.log("props.messageType:",n.messageType),a&&a.readyState===WebSocket.OPEN&&n.messageType){console.log("已经满足");const t={avatar:"",fromUsername:n.myName,from:n.myUuid,to:e.to||d.value,content:JSON.stringify(e),contentType:6,type:"webrtc-signal",messageType:1,url:"",fileSuffix:"",file:new Uint8Array},l=n.messageType.verify(t);if(l)return void console.error("信令消息格式错误:",l);console.log("信令消息:",t);const s=n.messageType.encode(n.messageType.create(t)).finish();a.send(s)}}function U(e){const a=JSON.parse(e.content);switch(console.log("处理信令消息:",a),a.type){case"call-invite":c.value=a.fromName,d.value=a.from,i.value="incoming",o.value=!0;break;case"call-accept":j();break;case"call-reject":alert("对方拒绝了通话"),S();break;case"call-hangup":S();break;case"offer":X(a.offer);break;case"answer":A(a.answer);break;case"ice-candidate":M(a.candidate);break}}async function j(){try{const e=await y.value.createOffer();await y.value.setLocalDescription(e),I({type:"offer",offer:e})}catch(e){console.error("创建Offer失败:",e)}}async function X(e){try{await y.value.setRemoteDescription(e);const a=await y.value.createAnswer();await y.value.setLocalDescription(a),I({type:"answer",answer:a})}catch(a){console.error("处理Offer失败:",a)}}async function A(e){try{await y.value.setRemoteDescription(e)}catch(a){console.error("处理Answer失败:",a)}}async function M(e){try{await y.value.addIceCandidate(e)}catch(a){console.error("添加ICE候选失败:",a)}}return a({startCall:C,handleSignalingMessage:U,endCall:S}),(0,l.xo)(()=>{S()}),(e,a)=>o.value?((0,l.uX)(),(0,l.CE)("div",Qa,["incoming"===i.value?((0,l.uX)(),(0,l.CE)("div",Ba,[(0,l.Lk)("div",Da,[a[0]||(a[0]=(0,l.Lk)("div",{class:"caller-avatar"},"📞",-1)),(0,l.Lk)("h3",null,(0,r.v_)(c.value),1),a[1]||(a[1]=(0,l.Lk)("p",null,"语音通话邀请",-1))]),(0,l.Lk)("div",{class:"call-actions"},[(0,l.Lk)("button",{onClick:R,class:"accept-btn"},"接听"),(0,l.Lk)("button",{onClick:_,class:"reject-btn"},"拒绝")])])):(0,l.Q3)("",!0),"calling"===i.value?((0,l.uX)(),(0,l.CE)("div",Ja,[(0,l.Lk)("div",Wa,[a[2]||(a[2]=(0,l.Lk)("div",{class:"caller-avatar"},"📞",-1)),(0,l.Lk)("h3",null,(0,r.v_)(v.value),1),a[3]||(a[3]=(0,l.Lk)("p",null,"正在呼叫...",-1))]),(0,l.Lk)("div",{class:"call-actions"},[(0,l.Lk)("button",{onClick:E,class:"reject-btn"},"挂断")])])):(0,l.Q3)("",!0),"connected"===i.value?((0,l.uX)(),(0,l.CE)("div",Va,[(0,l.Lk)("div",za,[a[4]||(a[4]=(0,l.Lk)("div",{class:"caller-avatar"},"🔊",-1)),(0,l.Lk)("h3",null,(0,r.v_)(v.value||c.value),1),(0,l.Lk)("p",null,"通话中 "+(0,r.v_)(b.value(f.value)),1)]),(0,l.Lk)("div",qa,[(0,l.Lk)("button",{onClick:T,class:(0,r.C4)([{active:m.value},"control-btn"])},(0,r.v_)(m.value?"🔇":"🎤"),3),(0,l.Lk)("button",{onClick:K,class:(0,r.C4)([{active:p.value},"control-btn"])},(0,r.v_)(p.value?"🔊":"🔈"),3),(0,l.Lk)("button",{onClick:E,class:"reject-btn"},"挂断")])])):(0,l.Q3)("",!0)])):(0,l.Q3)("",!0)}},Ha=(0,S.A)(Ga,[["__scopeId","data-v-170031f3"]]),Ya=Ha,Za={key:0,class:"video-call-overlay"},et={key:0,class:"call-interface incoming-call"},at={class:"caller-info"},tt={key:1,class:"call-interface outgoing-call"},nt={class:"caller-info"},lt={key:2,class:"video-call-interface"},st={class:"remote-video-container"},ot={class:"call-info-overlay"},it={class:"caller-name"},ct={class:"call-duration"},rt={class:"video-call-controls"},ut={__name:"WebRTCVideoCall",props:{myUuid:String,myName:String,messageType:Object},emits:["call-ended","call-started"],setup(e,{expose:a,emit:t}){const n=e,s=t,o=(0,u.KR)(!1),i=(0,u.KR)("idle"),c=(0,u.KR)(""),v=(0,u.KR)(""),d=(0,u.KR)(""),m=(0,u.KR)(!1),p=(0,u.KR)(!0),f=(0,u.KR)(!1),k=(0,u.KR)(!1),g=(0,u.KR)(!1),h=(0,u.KR)(0),y=(0,u.KR)([]),L=(0,u.KR)(0),b=(0,u.KR)(null),w=(0,u.KR)(null),C=(0,u.KR)(null),R=(0,u.KR)(null),_=(0,u.KR)(null),E=(0,u.KR)(null),S=((0,u.KR)([]),{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]}),T=(0,l.EW)(()=>e=>{const a=Math.floor(e/60),t=e%60;return`${a.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}`});async function K(){try{const e=await navigator.mediaDevices.enumerateDevices();y.value=e.filter(e=>"videoinput"===e.kind),g.value=y.value.length>1}catch(e){console.error("获取摄像头列表失败:",e)}}async function x(){try{const e={audio:!0,video:{width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30},facingMode:"user"}};R.value=await navigator.mediaDevices.getUserMedia(e),await(0,l.dY)(),w.value&&(w.value.srcObject=R.value),E.value=new RTCPeerConnection(S),R.value.getTracks().forEach(e=>{E.value.addTrack(e,R.value)}),E.value.ontrack=e=>{_.value=e.streams[0],N()},E.value.onicecandidate=e=>{e.candidate&&B({type:"ice-candidate",candidate:e.candidate})},E.value.onconnectionstatechange=()=>{console.log("Connection state:",E.value.connectionState),"connected"===E.value.connectionState?(i.value="connected",Q()):"disconnected"!==E.value.connectionState&&"failed"!==E.value.connectionState||X()},await K()}catch(e){console.error("初始化WebRTC失败:",e),alert("无法访问摄像头或麦克风，请检查权限设置")}}async function O(e,a){d.value=e,v.value=a,i.value="calling",o.value=!0,await x(),B({type:"video-call-invite",from:n.myUuid,fromName:n.myName,to:e}),s("call-started")}async function I(){await x(),B({type:"video-call-accept",from:n.myUuid,to:d.value}),i.value="connected"}function U(){B({type:"video-call-reject",from:n.myUuid,to:d.value}),X()}function j(){B({type:"video-call-hangup",from:n.myUuid,to:d.value}),X()}function X(){b.value&&(clearInterval(b.value),b.value=null),R.value&&(R.value.getTracks().forEach(e=>e.stop()),R.value=null),w.value&&(w.value.srcObject=null),C.value&&(C.value.srcObject=null),E.value&&(E.value.close(),E.value=null),i.value="idle",o.value=!1,L.value=0,c.value="",v.value="",d.value="",m.value=!1,p.value=!0,f.value=!1,k.value=!1,s("call-ended")}function A(){if(R.value){const e=R.value.getAudioTracks()[0];e&&(e.enabled=!e.enabled,m.value=!e.enabled)}}function M(){if(R.value){const e=R.value.getVideoTracks()[0];e&&(e.enabled=!e.enabled,p.value=e.enabled)}}async function $(){if(g.value&&R.value)try{const e=R.value.getVideoTracks()[0];e&&e.stop(),h.value=(h.value+1)%y.value.length;const a=y.value[h.value],t=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:a.deviceId},width:{ideal:1280},height:{ideal:720},frameRate:{ideal:30}}}),n=t.getVideoTracks()[0],l=E.value.getSenders().find(e=>e.track&&"video"===e.track.kind);l&&await l.replaceTrack(n);const s=R.value.getAudioTracks()[0];R.value=new MediaStream([s,n]),w.value&&(w.value.srcObject=R.value)}catch(e){console.error("切换摄像头失败:",e)}}function P(){f.value=!f.value}function F(){k.value=!k.value}function N(){_.value&&C.value&&(C.value.srcObject=_.value)}function Q(){b.value=setInterval(()=>{L.value++},1e3)}function B(e){const a=Fa();if(a&&a.readyState===WebSocket.OPEN&&n.messageType){const t={avatar:"",fromUsername:n.myName,from:n.myUuid,to:e.to||d.value,content:JSON.stringify(e),contentType:7,type:"webrtc-video-signal",messageType:1,url:"",fileSuffix:"",file:new Uint8Array},l=n.messageType.verify(t);if(l)return void console.error("信令消息格式错误:",l);const s=n.messageType.encode(n.messageType.create(t)).finish();a.send(s)}}function D(e){const a=JSON.parse(e.content);switch(console.log("处理视频信令消息:",a),a.type){case"video-call-invite":c.value=a.fromName,d.value=a.from,i.value="incoming",o.value=!0;break;case"video-call-accept":J();break;case"video-call-reject":alert("对方拒绝了视频通话"),X();break;case"video-call-hangup":X();break;case"offer":W(a.offer);break;case"answer":V(a.answer);break;case"ice-candidate":z(a.candidate);break}}async function J(){try{const e=await E.value.createOffer();await E.value.setLocalDescription(e),B({type:"offer",offer:e})}catch(e){console.error("创建Offer失败:",e)}}async function W(e){try{await E.value.setRemoteDescription(e);const a=await E.value.createAnswer();await E.value.setLocalDescription(a),B({type:"answer",answer:a})}catch(a){console.error("处理Offer失败:",a)}}async function V(e){try{await E.value.setRemoteDescription(e)}catch(a){console.error("处理Answer失败:",a)}}async function z(e){try{await E.value.addIceCandidate(e)}catch(a){console.error("添加ICE候选失败:",a)}}return a({startCall:O,handleSignalingMessage:D,endCall:X}),(0,l.xo)(()=>{X()}),(e,a)=>o.value?((0,l.uX)(),(0,l.CE)("div",Za,["incoming"===i.value?((0,l.uX)(),(0,l.CE)("div",et,[(0,l.Lk)("div",at,[a[0]||(a[0]=(0,l.Lk)("div",{class:"caller-avatar"},"📹",-1)),(0,l.Lk)("h3",null,(0,r.v_)(c.value),1),a[1]||(a[1]=(0,l.Lk)("p",null,"视频通话邀请",-1))]),(0,l.Lk)("div",{class:"call-actions"},[(0,l.Lk)("button",{onClick:I,class:"accept-btn"},"接听"),(0,l.Lk)("button",{onClick:U,class:"reject-btn"},"拒绝")])])):(0,l.Q3)("",!0),"calling"===i.value?((0,l.uX)(),(0,l.CE)("div",tt,[(0,l.Lk)("div",nt,[a[2]||(a[2]=(0,l.Lk)("div",{class:"caller-avatar"},"📹",-1)),(0,l.Lk)("h3",null,(0,r.v_)(v.value),1),a[3]||(a[3]=(0,l.Lk)("p",null,"正在呼叫...",-1))]),(0,l.Lk)("div",{class:"call-actions"},[(0,l.Lk)("button",{onClick:j,class:"reject-btn"},"挂断")])])):(0,l.Q3)("",!0),"connected"===i.value?((0,l.uX)(),(0,l.CE)("div",lt,[(0,l.Lk)("div",st,[(0,l.Lk)("video",{ref_key:"remoteVideo",ref:C,class:"remote-video",autoplay:"",playsinline:"",muted:!1},null,512),(0,l.Lk)("div",ot,[(0,l.Lk)("div",it,(0,r.v_)(v.value||c.value),1),(0,l.Lk)("div",ct,(0,r.v_)(T.value(L.value)),1)])]),(0,l.Lk)("div",{class:(0,r.C4)(["local-video-container",{minimized:k.value}])},[(0,l.Lk)("video",{ref_key:"localVideo",ref:w,class:"local-video",autoplay:"",playsinline:"",muted:""},null,512),(0,l.Lk)("button",{onClick:F,class:"toggle-size-btn"},"⤢")],2),(0,l.Lk)("div",rt,[(0,l.Lk)("button",{onClick:A,class:(0,r.C4)([{active:m.value},"control-btn"]),title:"静音"},(0,r.v_)(m.value?"🔇":"🎤"),3),(0,l.Lk)("button",{onClick:M,class:(0,r.C4)([{active:!p.value},"control-btn"]),title:"关闭摄像头"},(0,r.v_)(p.value?"📹":"📷"),3),g.value?((0,l.uX)(),(0,l.CE)("button",{key:0,onClick:$,class:"control-btn",title:"切换摄像头"}," 🔄 ")):(0,l.Q3)("",!0),(0,l.Lk)("button",{onClick:P,class:(0,r.C4)([{active:f.value},"control-btn"]),title:"扬声器"},(0,r.v_)(f.value?"🔊":"🔈"),3),(0,l.Lk)("button",{onClick:j,class:"reject-btn",title:"挂断"},"📞")])])):(0,l.Q3)("",!0)])):(0,l.Q3)("",!0)}},vt=(0,S.A)(ut,[["__scopeId","data-v-9c5bcdf8"]]),dt=vt;class mt{constructor(){this.pendingAcks=new Set,this.ackTimer=null,this.ackDelay=1e3,this.messageObserver=null,this.visibilityObserver=null,this.myUuid="",this.MessageType=null,this.messageElements=new Map,this.readMessages=new Set}init(e,a){this.myUuid=e,this.MessageType=a,this.setupIntersectionObserver(),this.setupVisibilityObserver()}setupIntersectionObserver(){const e={root:null,rootMargin:"0px",threshold:.5};this.messageObserver=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const a=e.target.dataset.messageId,t=e.target.dataset.fromUuid;a&&t&&t!==this.myUuid&&this.markMessageAsRead(a)}})},e)}setupVisibilityObserver(){this.visibilityObserver=()=>{document.hidden||this.flushPendingAcks()},document.addEventListener("visibilitychange",this.visibilityObserver)}registerMessageElement(e,a,t){e&&a&&t!==this.myUuid&&(a.dataset.messageId=e,a.dataset.fromUuid=t,this.messageElements.set(e,a),this.messageObserver.observe(a))}unregisterMessageElement(e){const a=this.messageElements.get(e);a&&(this.messageObserver.unobserve(a),this.messageElements.delete(e))}markMessageAsRead(e){this.readMessages.has(e)||(this.readMessages.add(e),this.pendingAcks.add(e),this.scheduleAckSend())}scheduleAckSend(){this.ackTimer&&clearTimeout(this.ackTimer),this.ackTimer=setTimeout(()=>{this.flushPendingAcks()},this.ackDelay)}flushPendingAcks(){if(0===this.pendingAcks.size)return;const e=Fa();if(!e||e.readyState!==WebSocket.OPEN||!this.MessageType)return;const a=Array.from(this.pendingAcks),t={avatar:"",fromUsername:"",from:this.myUuid,to:"",content:"ack",contentType:10,type:"ack",messageType:1,url:"",fileSuffix:"",file:new Uint8Array,messageId:"",isFragmented:!1,fragmentIndex:0,totalFragments:0,timestamp:Date.now(),checksum:"",ackMessageIds:a,isRead:!0,readTimestamp:Date.now()};try{const n=this.MessageType.encode(this.MessageType.create(t)).finish();e.send(n),console.log(`发送ACK确认，包含${a.length}条消息:`,a),this.pendingAcks.clear(),this.ackTimer&&(clearTimeout(this.ackTimer),this.ackTimer=null)}catch(n){console.error("发送ACK消息失败:",n)}}markChatAsRead(e,a){a&&0!==a.length&&(a.forEach(e=>{e.from!==this.myUuid&&e.messageId&&this.markMessageAsRead(e.messageId)}),this.flushPendingAcks())}isMessageRead(e){return this.readMessages.has(e)}handleAckMessage(e){if(e.ackMessageIds&&e.ackMessageIds.length>0){console.log("收到ACK确认:",e.ackMessageIds);const a=new CustomEvent("messagesAcked",{detail:{messageIds:e.ackMessageIds,readTimestamp:e.readTimestamp,from:e.from}});window.dispatchEvent(a)}}destroy(){this.messageObserver&&(this.messageObserver.disconnect(),this.messageObserver=null),this.visibilityObserver&&(document.removeEventListener("visibilitychange",this.visibilityObserver),this.visibilityObserver=null),this.ackTimer&&(clearTimeout(this.ackTimer),this.ackTimer=null),this.pendingAcks.clear(),this.messageElements.clear(),this.readMessages.clear()}}const pt=new mt,ft={class:"chat-container"},kt={class:"chat-header chat-header-center"},gt={key:0},ht={key:1},yt={key:2,class:"header-actions"},Lt={class:"msg-bubble"},bt={class:"sender"},wt={key:0,class:"content"},Ct=["href"],Rt={key:1,class:"content"},_t=["src","onClick"],Et={key:2,class:"content"},St=["src","onClick"],Tt={key:3,class:"content"},Kt=["src"],xt={key:4,class:"content"},Ot={class:"message-footer"},It={class:"timestamp"},Ut={key:0,class:"read-status"},jt={key:0,class:"read-indicator"},Xt={key:1,class:"unread-indicator"},At={key:0,class:"message other"},Mt={class:"typing-indicator"},$t={class:"sender"},Pt={class:"input-area-wrap"},Ft={class:"input-actions input-actions-top"},Nt=["onClick"],Qt={class:"input-area"},Bt={key:0,class:"ws-status"},Dt={class:"image-preview-container"},Jt=["src"],Wt={class:"video-preview-container"},Vt=["src"],zt={__name:"MessageLayout",setup(e){const a=(0,c.lq)(),t=a.query.session||"default",s=(0,l.EW)(()=>k.value[v.value]||[]),o=(0,u.KR)(""),i=JSON.parse(localStorage.getItem(`userinfo_${t}`)||"{}"),g=i.nickname||"我",C=i.uuid,R=(0,u.KR)(null);let _=null;const E=(0,u.KR)(!1),S=(0,l.EW)(()=>p.value),T=(0,u.KR)(null),K=(0,u.KR)(!1),x=(0,u.KR)(null),O=(0,u.KR)([]),I=(0,u.KR)(null),U=(0,u.KR)(!1),j=(0,u.KR)(null),X=(0,u.KR)(!1),A=(0,u.KR)(!1),M=(0,u.KR)(""),$=(0,u.KR)(""),P=(0,u.KR)(null),F=(0,u.KR)(null),N=(0,u.KR)(null),Q=(0,u.KR)(new Set),B=(0,u.KR)(!1),D=(0,u.KR)(""),J=(0,u.KR)(null);async function W(e){const a=e.target.files[0];if(!a)return;const t=new FileReader;t.onload=async e=>{const t=new Uint8Array(e.target.result),n=a.name,l=a.name.split(".").pop();V({fileName:n,fileBuffer:t,suffix:l})},t.readAsArrayBuffer(a)}function V(e){if(!R.value||!E.value)return;let a=2,t="file";const n=["jpg","jpeg","png","gif","bmp","webp"],l=["mp4","avi","mov","wmv","flv","mkv"];n.includes(e.suffix.toLowerCase())?(a=3,t="image"):l.includes(e.suffix.toLowerCase())&&(a=5,t="video");const s={avatar:"",fromUsername:g,from:C,to:v.value,content:e.fileName,contentType:a,type:t,messageType:w.value,url:URL.createObjectURL(new Blob([e.fileBuffer])),fileSuffix:e.suffix,file:e.fileBuffer,messageId:Ue(),isFragmented:!1,fragmentIndex:0,totalFragments:0,timestamp:Date.now(),checksum:"",ackMessageIds:[],isRead:!1,readTimestamp:0},o=R.value.encode(R.value.create(s)).finish();_.send(o),k.value[v.value]||(k.value[v.value]=[]),k.value[v.value].push({...s,timestamp:Date.now()})}async function z(){if(K.value)x.value.stop(),K.value=!1;else try{const e=await navigator.mediaDevices.getUserMedia({audio:!0});O.value=[],x.value=new MediaRecorder(e),x.value.ondataavailable=e=>{O.value.push(e.data)},x.value.onstop=async()=>{I.value=new Blob(O.value,{type:"audio/webm"});const a=await I.value.arrayBuffer();q({audioBuffer:new Uint8Array(a),duration:Math.round(I.value.duration)}),e.getTracks().forEach(e=>e.stop())},x.value.start(),K.value=!0}catch(e){alert("麦克风访问被拒绝")}}function q(e){if(!R.value||!E.value)return;const a={...e,avatar:"",fromUsername:g,from:C,to:v.value,content:"语音消息",contentType:4,type:"audio",messageType:w.value,url:URL.createObjectURL(I.value),file:e.audioBuffer,messageId:Ue(),isFragmented:!1,fragmentIndex:0,totalFragments:0,timestamp:Date.now(),checksum:"",ackMessageIds:[],isRead:!1,readTimestamp:0},t=R.value.encode(R.value.create(a)).finish();_.send(t),k.value[v.value]||(k.value[v.value]=[]),k.value[v.value].push({...a,timestamp:Date.now()})}function G(e){if(!e)return"0:00";const a=Math.floor(e/60),t=String(e%60).padStart(2,"0");return`${a}:${t}`}function H(){const e={};d.value.forEach(a=>{a.unread>0&&(e[a.uuid]=a.unread)}),m.value.forEach(a=>{a.unread>0&&(e[a.uuid]=a.unread)}),localStorage.setItem(`unreadCounts_${t}`,JSON.stringify(e))}(0,l.sV)(async()=>{const e=await ja().load("/message.proto");R.value=e.lookup("protocol.Message"),Pa(t,Z,C,R.value),_=Fa(),_&&(E.value=_.readyState===WebSocket.OPEN,_.addEventListener("open",()=>E.value=!0),_.addEventListener("close",()=>E.value=!1)),pt.init(C,R.value),window.addEventListener("messagesAcked",Me)});const Y=new Map;function Z(e){if(!R.value)return;const a=new Uint8Array(e.data),t=R.value.decode(a);var n=t;if(t.isFragmented){const e=ee(t);if(!e)return void console.log("分片消息未完成");n=e}const{from:l,to:s,file:o}=n,i=s===C,c=i?l:s;try{switch(n.contentType){case 1:te(n,c,i);break;case 2:ne(n,c,i);break;case 3:le(n,c,i);break;case 4:oe(n,c,i);break;case 5:se(n,c,i);break;case 6:re(n);break;case 7:ue(n);break;case 8:ie(n);break;case 9:ce(n);break;case 10:Ae(n);break;default:console.log("未知消息类型");break}H()}catch(r){console.log("未知消息类型")}}function ee(e){const a=e.messageId;Y.has(a)||Y.set(a,{fragments:new Array(e.totalFragments),receivedCount:0,timestamp:Date.now()});const t=Y.get(a);if(t.fragments[e.fragmentIndex])return console.warn(`重复收到分片 ${e.fragmentIndex}`),null;if(t.fragments[e.fragmentIndex]=e,t.receivedCount++,console.log(`收到分片 ${e.fragmentIndex+1}/${e.totalFragments}`),t.receivedCount===e.totalFragments){const e=ae(t.fragments);return Y.delete(a),console.log("消息重组完成:",a),e}return null}function ae(e){e.sort((e,a)=>e.fragmentIndex-a.fragmentIndex);let a=0;e.forEach(e=>{e.file&&(a+=e.file.length)});const t=new Uint8Array(a);let n=0;e.forEach(e=>{e.file&&(t.set(e.file,n),n+=e.file.length)});try{const e=R.value.decode(t);return e.isFragmented=!1,console.log(e),e}catch(l){return console.error("反序列化失败:",l),null}}function te(e,a,t){ge(a,t),he(a,e)}function ne(e,a,t){console.log("type: ",e.fileSuffix),e.url=URL.createObjectURL(new Blob([e.file],{type:ye(e.fileSuffix)})),console.log(e),ge(a,t),he(a,e)}function le(e,a,t){console.log("图片消息: ",e.fileSuffix),e.url=URL.createObjectURL(new Blob([e.file],{type:ye(e.fileSuffix)})),ge(a,t),he(a,e)}function se(e,a,t){e.url=URL.createObjectURL(new Blob([e.file],{type:ye(e.fileSuffix)})),ge(a,t),he(a,e)}function oe(e,a,t){e.url=URL.createObjectURL(new Blob([e.file],{getType:ye(e.fileSuffix)})),ge(a,t),he(a,e)}function ie(e){y.value={fromUsername:e.fromUsername,content:e.content,from:e.from},h.value=!0}function ce(e){b.value={fromUsername:e.fromUsername,content:e.content,from:e.from},L.value=!0}function re(e){P.value&&P.value.handleSignalingMessage(e)}function ue(e){F.value&&F.value.handleSignalingMessage(e)}function ve(){v.value&&S.value?P.value&&P.value.startCall(v.value,S.value):alert("请先选择聊天对象")}function de(){v.value&&S.value?F.value&&F.value.startCall(v.value,S.value):alert("请先选择聊天对象")}function me(){console.log("语音通话已开始")}function pe(){console.log("语音通话已结束")}function fe(){console.log("视频通话已开始")}function ke(){console.log("视频通话已结束")}function ge(e,a){if(f.value!==e){const t=a?d.value:m.value,n=t.find(a=>a.uuid===e);n&&(console.log("更新未读消息数量"),n.unread++)}}function he(e,a){k.value[e]??=[],console.log("audio: ",a),a.messageId||(a.messageId=Ue()),k.value[e].push({...a,timestamp:a.timestamp||Date.now()})}function ye(e){const a={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",mp4:"video/mp4",avi:"video/x-msvideo",mov:"video/quicktime",wmv:"video/x-ms-wmv",flv:"video/x-flv",mkv:"video/x-matroska",pdf:"application/pdf",txt:"text/plain",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",zip:"application/zip",rar:"application/x-rar-compressed","7z":"application/x-7z-compressed",mp3:"audio/mpeg",wav:"audio/wav",aac:"audio/aac",flac:"audio/flac",ogg:"audio/ogg",m4a:"audio/m4a"};return a[e?.toLowerCase()]||"application/octet-stream"}function Le(e){const a=new Date(e);return a.toLocaleTimeString()}function be(){o.value.trim()?we():Ce()}function we(){J.value&&clearTimeout(J.value),B.value=!0,D.value="对方",J.value=setTimeout(()=>{Ce()},3e3)}function Ce(){B.value=!1,D.value="",J.value&&(clearTimeout(J.value),J.value=null)}function Re(){if(Ce(),!o.value.trim()||!R.value||!E.value)return;if(!v.value.trim())return void alert("请先选择聊天对象");const e={avatar:"",fromUsername:g,from:C,to:v.value,content:o.value,contentType:1,type:"",messageType:w.value,url:"",fileSuffix:"",file:new Uint8Array,messageId:Ue(),isFragmented:!1,fragmentIndex:0,totalFragments:0,timestamp:Date.now(),checksum:"",ackMessageIds:[],isRead:!1,readTimestamp:0},a=R.value.verify(e);if(a)return void alert("消息格式错误: "+a);const t=R.value.encode(R.value.create(e)).finish();_.send(t),k.value[v.value]||(k.value[v.value]=[]),k.value[v.value].push({...e,timestamp:Date.now()}),o.value=""}function _e(e){alert(e+"功能暂未实现")}function Ee(){U.value=!U.value,U.value?(0,l.dY)(()=>{document.addEventListener("mousedown",Se)}):document.removeEventListener("mousedown",Se)}function Se(e){j.value&&!j.value.contains(e.target)&&(U.value=!1,document.removeEventListener("mousedown",Se))}function Te(e){o.value+=e,U.value=!1,document.removeEventListener("mousedown",Se)}function Ke(e){M.value=e,X.value=!0}function xe(){X.value=!1,M.value=""}function Oe(e){$.value=e,A.value=!0}function Ie(){A.value=!1,$.value=""}function Ue(){return`msg_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function je(e,a){a&&e.messageId&&e.from!==C&&(0,l.dY)(()=>{pt.registerMessageElement(e.messageId,a,e.from)})}function Xe(e){return Q.value.has(e)}function Ae(e){pt.handleAckMessage(e)}function Me(e){const{messageIds:a}=e.detail;a.forEach(e=>{Q.value.add(e)})}return setInterval(()=>{const e=Date.now(),a=3e4;for(const[t,n]of Y.entries())e-n.timestamp>a&&(console.warn(`清理过期分片: ${t}`),Y.delete(t))},1e4),(0,l.xo)(()=>{Na(),pt.destroy(),window.removeEventListener("messagesAcked",Me)}),(0,l.xo)(()=>{document.removeEventListener("mousedown",Se)}),(0,l.wB)(v,(e,a)=>{e&&e!==a&&(0,l.dY)(()=>{const a=s.value;a.length>0&&pt.markChatAsRead(e,a)})}),(0,l.wB)(()=>document.hidden,e=>{!e&&v.value&&(0,l.dY)(()=>{const e=s.value;e.length>0&&pt.markChatAsRead(v.value,e)})}),(e,a)=>((0,l.uX)(),(0,l.CE)("div",ft,[(0,l.Lk)("div",kt,[S.value?((0,l.uX)(),(0,l.CE)("span",gt,(0,r.v_)(S.value),1)):((0,l.uX)(),(0,l.CE)("span",ht,"select")),S.value?((0,l.uX)(),(0,l.CE)("div",yt,[(0,l.Lk)("button",{onClick:ve,class:"voice-call-btn",title:"语音通话"}," 📞 "),(0,l.Lk)("button",{onClick:de,class:"video-call-btn",title:"视频通话"}," 📹 ")])):(0,l.Q3)("",!0)]),(0,l.Lk)("div",{class:"messages",ref_key:"messagesContainer",ref:N},[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)(s.value,(e,t)=>((0,l.uX)(),(0,l.CE)("div",{key:e.messageId||t,class:(0,r.C4)(["message",e.from===(0,u.R1)(C)?"self":"other"]),ref_for:!0,ref:a=>je(e,a)},[(0,l.Lk)("div",Lt,[(0,l.Lk)("span",bt,(0,r.v_)(e.fromUsername)+"：",1),2===e.contentType?((0,l.uX)(),(0,l.CE)("span",wt,[a[5]||(a[5]=(0,l.eW)(" 📎 文件：",-1)),(0,l.Lk)("a",{href:e.url,download:""},(0,r.v_)(e.content),9,Ct),(0,l.eW)(" ("+(0,r.v_)((0,u.R1)(Xa)(e.file?.length))+") ",1)])):3===e.contentType?((0,l.uX)(),(0,l.CE)("span",Rt,[a[6]||(a[6]=(0,l.eW)(" 🖼️ 图片：",-1)),(0,l.Lk)("img",{src:e.url,style:{"max-width":"200px","border-radius":"4px",cursor:"pointer"},onClick:a=>Ke(e.url)},null,8,_t)])):5===e.contentType?((0,l.uX)(),(0,l.CE)("span",Et,[a[7]||(a[7]=(0,l.eW)(" 🎥 视频：",-1)),(0,l.Lk)("video",{src:e.url,style:{"max-width":"200px","border-radius":"4px",cursor:"pointer"},onClick:a=>Oe(e.url)},null,8,St)])):(0,l.Q3)("",!0),4===e.contentType?((0,l.uX)(),(0,l.CE)("span",Tt,[a[8]||(a[8]=(0,l.eW)(" 🎤 语音消息： ",-1)),(0,l.Lk)("audio",{src:e.url,controls:"",style:{"vertical-align":"middle"}},null,8,Kt),(0,l.eW)(" ("+(0,r.v_)(G(e.duration))+") ",1)])):((0,l.uX)(),(0,l.CE)("span",xt,(0,r.v_)(e.content),1)),(0,l.Lk)("div",Ot,[(0,l.Lk)("span",It,(0,r.v_)(Le(e.timestamp)),1),e.from===(0,u.R1)(C)&&e.messageId?((0,l.uX)(),(0,l.CE)("span",Ut,[Xe(e.messageId)?((0,l.uX)(),(0,l.CE)("span",jt,"✓✓")):((0,l.uX)(),(0,l.CE)("span",Xt,"✓"))])):(0,l.Q3)("",!0)])])],2))),128)),B.value?((0,l.uX)(),(0,l.CE)("div",At,[(0,l.Lk)("div",Mt,[(0,l.Lk)("span",$t,(0,r.v_)(D.value)+"正在输入",1),a[9]||(a[9]=(0,l.Lk)("div",{class:"typing-dots"},[(0,l.Lk)("div",{class:"typing-dot"}),(0,l.Lk)("div",{class:"typing-dot"}),(0,l.Lk)("div",{class:"typing-dot"})],-1))])])):(0,l.Q3)("",!0)],512),(0,l.Lk)("div",Pt,[(0,l.Lk)("div",Ft,[(0,l.Lk)("button",{class:"input-action-btn",onClick:Ee,title:"发送表情"},"😊"),(0,l.Lk)("input",{type:"file",ref_key:"fileInput",ref:T,style:{display:"none"},onChange:W},null,544),(0,l.Lk)("button",{class:"input-action-btn",onClick:a[0]||(a[0]=a=>e.$refs.fileInput.click()),title:"发送文件"},"📄"),(0,l.Lk)("button",{class:(0,r.C4)(["input-action-btn",{recording:K.value}]),onClick:z,title:"语音消息"},(0,r.v_)(K.value?"⏹":"🎤"),3),(0,l.Lk)("button",{class:"input-action-btn",onClick:a[1]||(a[1]=e=>_e("视频")),title:"发送视频"},"🎥")]),U.value?((0,l.uX)(),(0,l.CE)("div",{key:0,class:"emoji-panel",ref_key:"emojiPanelRef",ref:j},[((0,l.uX)(!0),(0,l.CE)(l.FK,null,(0,l.pI)((0,u.R1)(Aa),e=>((0,l.uX)(),(0,l.CE)("span",{key:e,class:"emoji-item",onClick:a=>Te(e)},(0,r.v_)(e),9,Nt))),128))],512)):(0,l.Q3)("",!0),(0,l.Lk)("div",Qt,[(0,l.bo)((0,l.Lk)("textarea",{"onUpdate:modelValue":a[2]||(a[2]=e=>o.value=e),onKeyup:(0,n.jR)(Re,["enter"]),onInput:be,placeholder:"输入消息...",rows:"1",class:"msg-textarea"},null,544),[[n.Jo,o.value]]),(0,l.Lk)("button",{onClick:Re},"发送")])]),E.value?(0,l.Q3)("",!0):((0,l.uX)(),(0,l.CE)("div",Bt,"WebSocket 未连接")),X.value?((0,l.uX)(),(0,l.CE)("div",{key:1,class:"image-preview-modal",onClick:xe},[(0,l.Lk)("div",Dt,[(0,l.Lk)("img",{src:M.value,class:"preview-image",onClick:a[3]||(a[3]=(0,n.D$)(()=>{},["stop"]))},null,8,Jt),(0,l.Lk)("button",{class:"close-preview-btn",onClick:xe},"×")])])):(0,l.Q3)("",!0),A.value?((0,l.uX)(),(0,l.CE)("div",{key:2,class:"video-preview-modal",onClick:Ie},[(0,l.Lk)("div",Wt,[(0,l.Lk)("video",{src:$.value,class:"preview-video",controls:"",onClick:a[4]||(a[4]=(0,n.D$)(()=>{},["stop"]))},null,8,Vt),(0,l.Lk)("button",{class:"close-preview-btn",onClick:Ie},"×")])])):(0,l.Q3)("",!0),R.value?((0,l.uX)(),(0,l.Wv)(Ya,{key:3,ref_key:"voiceCallRef",ref:P,"my-uuid":(0,u.R1)(C),"my-name":(0,u.R1)(g),"message-type":R.value,onCallStarted:me,onCallEnded:pe},null,8,["my-uuid","my-name","message-type"])):(0,l.Q3)("",!0),R.value?((0,l.uX)(),(0,l.Wv)(dt,{key:4,ref_key:"videoCallRef",ref:F,"my-uuid":(0,u.R1)(C),"my-name":(0,u.R1)(g),"message-type":R.value,onCallStarted:fe,onCallEnded:ke},null,8,["my-uuid","my-name","message-type"])):(0,l.Q3)("",!0)]))}},qt=(0,S.A)(zt,[["__scopeId","data-v-805c1e7e"]]),Gt=qt,Ht={class:"chat-layout"},Yt={__name:"Chat",setup(e){return(e,a)=>((0,l.uX)(),(0,l.CE)("div",Ht,[(0,l.bF)(Ia),(0,l.bF)(Gt)]))}},Zt=Yt,en=Zt,an={class:"login-bg"},tn={class:"login-box"},nn={class:"login-tabs"},ln={class:"login-form-item"},sn={key:0,class:"login-form-item"},on={class:"login-form-item"},cn={class:"login-form-item"},rn=["disabled"],un={key:1,class:"login-error"},vn={__name:"LoginRegister",setup(e){const a=(0,u.KR)("login"),t=(0,u.KR)(""),s=(0,u.KR)(""),o=(0,u.KR)(""),i=(0,u.KR)(!1),v=(0,u.KR)(""),d=(0,c.rd)();async function m(){v.value="",i.value=!0;try{const e=await fetch("http://62.234.192.227/v1/api/user/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t.value,password:s.value})}),a=await e.json();if(200===a.code&&a.data&&a.data.token){const e=f();localStorage.setItem(`token_${e}`,a.data.token),localStorage.setItem(`userinfo_${e}`,JSON.stringify(a.data.userinfo)),d.push({path:"/chat",query:{session:e}})}else v.value=a.msg||"登录失败"}catch(e){v.value="网络错误"}finally{i.value=!1}}async function p(){v.value="",i.value=!0;try{const e=await fetch("http://62.234.192.227/v1/api/user/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t.value,password:s.value,nickname:o.value})}),n=await e.json();200===n.code?(a.value="login",v.value="注册成功，请登录"):v.value=n.data||"注册失败"}catch(e){v.value="网络错误"}finally{i.value=!1}}function f(){const e=new URLSearchParams(window.location.search);return e.get("session")||Math.random().toString(36).substr(2,9)}return(e,c)=>((0,l.uX)(),(0,l.CE)("div",an,[(0,l.Lk)("div",tn,[(0,l.Lk)("div",nn,[(0,l.Lk)("div",{class:(0,r.C4)(["login-tab",{active:"login"===a.value}]),onClick:c[0]||(c[0]=e=>a.value="login")},"登录",2),(0,l.Lk)("div",{class:(0,r.C4)(["login-tab",{active:"register"===a.value}]),onClick:c[1]||(c[1]=e=>a.value="register")},"注册",2)]),(0,l.Lk)("form",{onSubmit:c[5]||(c[5]=(0,n.D$)(e=>"login"===a.value?m():p(),["prevent"]))},[(0,l.Lk)("div",ln,[(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":c[2]||(c[2]=e=>t.value=e),placeholder:"用户名",required:""},null,512),[[n.Jo,t.value]])]),"register"===a.value?((0,l.uX)(),(0,l.CE)("div",sn,[(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":c[3]||(c[3]=e=>o.value=e),placeholder:"昵称",required:""},null,512),[[n.Jo,o.value]])])):(0,l.Q3)("",!0),(0,l.Lk)("div",on,[(0,l.bo)((0,l.Lk)("input",{"onUpdate:modelValue":c[4]||(c[4]=e=>s.value=e),type:"password",placeholder:"密码",required:""},null,512),[[n.Jo,s.value]])]),(0,l.Lk)("div",cn,[(0,l.Lk)("button",{type:"submit",disabled:i.value},(0,r.v_)("login"===a.value?"登录":"注册"),9,rn)]),v.value?((0,l.uX)(),(0,l.CE)("div",un,(0,r.v_)(v.value),1)):(0,l.Q3)("",!0)],32)])]))}},dn=(0,S.A)(vn,[["__scopeId","data-v-ce4b13ea"]]),mn=dn,pn=[{path:"/",component:mn},{path:"/chat",name:"Chat",component:en,meta:{requiresAuth:!0}},{path:"/login",name:"Login",component:mn}],fn=(0,c.aE)({history:(0,c.LA)(),routes:pn});fn.beforeEach((e,a,t)=>{const n=e.query.session,l=n?localStorage.getItem(`token_${n}`):null;e.meta.requiresAuth&&!l?t({path:"/login"}):"/login"===e.path&&l?t({path:"/chat",query:{session:n}}):t()});const kn=fn;(0,n.Ef)(i).use(kn).mount("#app")}},a={};function t(n){var l=a[n];if(void 0!==l)return l.exports;var s=a[n]={exports:{}};return e[n].call(s.exports,s,s.exports,t),s.exports}t.m=e,(()=>{var e=[];t.O=(a,n,l,s)=>{if(!n){var o=1/0;for(u=0;u<e.length;u++){for(var[n,l,s]=e[u],i=!0,c=0;c<n.length;c++)(!1&s||o>=s)&&Object.keys(t.O).every(e=>t.O[e](n[c]))?n.splice(c--,1):(i=!1,s<o&&(o=s));if(i){e.splice(u--,1);var r=l();void 0!==r&&(a=r)}}return a}s=s||0;for(var u=e.length;u>0&&e[u-1][2]>s;u--)e[u]=e[u-1];e[u]=[n,l,s]}})(),(()=>{t.n=e=>{var a=e&&e.__esModule?()=>e["default"]:()=>e;return t.d(a,{a}),a}})(),(()=>{t.d=(e,a)=>{for(var n in a)t.o(a,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:a[n]})}})(),(()=>{t.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()})(),(()=>{t.o=(e,a)=>Object.prototype.hasOwnProperty.call(e,a)})(),(()=>{var e={524:0};t.O.j=a=>0===e[a];var a=(a,n)=>{var l,s,[o,i,c]=n,r=0;if(o.some(a=>0!==e[a])){for(l in i)t.o(i,l)&&(t.m[l]=i[l]);if(c)var u=c(t)}for(a&&a(n);r<o.length;r++)s=o[r],t.o(e,s)&&e[s]&&e[s][0](),e[s]=0;return t.O(u)},n=self["webpackChunkchat_web"]=self["webpackChunkchat_web"]||[];n.forEach(a.bind(null,0)),n.push=a.bind(null,n.push.bind(n))})();var n=t.O(void 0,[504],()=>t(7143));n=t.O(n)})();
//# sourceMappingURL=app.cf325b5a.js.map